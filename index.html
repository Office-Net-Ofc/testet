<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Confirma√ß√£o de Presen√ßa - Pedro D√¥mini</title>

<style>
body {
  font-family: 'Segoe UI', Arial, sans-serif;
  background: #f7f2e8;
  min-height: 100vh;
  margin: 0;
  overflow-x: hidden;
}

.folhas {
  position: fixed;
  inset: 0;
  pointer-events: none;
  z-index: 1;
}

.folha {
  position: absolute;
  width: 28px;
  opacity: 0.6;
  animation: cair linear infinite;
}

@keyframes cair {
  from { transform: translateY(-50px) rotate(0deg); }
  to { transform: translateY(110vh) rotate(360deg); }
}

.container {
  position: relative;
  z-index: 2;
  background: #ffffff;
  padding: 30px;
  border-radius: 18px;
  max-width: 440px;
  margin: 40px auto;
  box-shadow: 0 15px 35px rgba(0,0,0,0.15);
  border: 4px solid #2f7d32;
}

.header-img {
  width: 100%;
  max-width: 340px;
  display: block;
  margin: 0 auto 20px;
}

h2 { text-align: center; color: #2f7d32; }

label {
  font-weight: 600;
  margin-top: 18px;
  display: block;
  color: #4e342e;
}

input, textarea, select {
  width: 100%;
  padding: 12px;
  margin-top: 6px;
  border-radius: 8px;
  border: 1px solid #cfcfcf;
  font-size: 15px;
}

textarea { resize: vertical; }

button {
  margin-top: 25px;
  width: 100%;
  padding: 15px;
  background-color: #2f7d32;
  color: white;
  font-size: 17px;
  border: none;
  border-radius: 10px;
  cursor: pointer;
}

button:hover { background-color: #256428; }
button:disabled { opacity: .6; cursor: not-allowed; }

/* LOADING */
#loading {
  display: none;
  position: fixed;
  inset: 0;
  background: rgba(255,255,255,0.96);
  z-index: 9999;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  text-align: center;
  padding: 20px;
}

.notice {
  margin-top: 14px;
  background: #fff8e1;
  border: 1px solid #ffe0a3;
  color: #5d4037;
  padding: 12px;
  border-radius: 12px;
  font-size: 14px;
  line-height: 1.35;
  display: none;
}
.notice b { color: #3e2723; }

/* FALLBACK WHATSAPP */
#waFallback {
  display: none;
  position: fixed;
  inset: 0;
  background: rgba(255,255,255,0.98);
  z-index: 99999;
  padding: 20px;
}
#waFallback .card {
  max-width: 520px;
  margin: 40px auto;
  background: #fff;
  border: 1px solid #ddd;
  border-radius: 16px;
  padding: 18px;
  box-shadow: 0 10px 30px rgba(0,0,0,.12);
}
#waFallback h3 {
  margin: 0 0 10px;
  color: #2f7d32;
}
#waFallback p {
  margin: 0 0 12px;
  color: #4e342e;
  line-height: 1.35;
}
#waFallback textarea {
  width: 100%;
  padding: 12px;
  border-radius: 10px;
  border: 1px solid #cfcfcf;
  font-size: 14px;
}
#waFallback .row {
  display: flex;
  gap: 10px;
  margin-top: 12px;
  flex-wrap: wrap;
}
#waFallback .btn {
  flex: 1;
  padding: 12px;
  border-radius: 10px;
  border: none;
  cursor: pointer;
  font-size: 15px;
}
#waFallback .btn-primary { background: #2f7d32; color: #fff; }
#waFallback .btn-dark { background: #256428; color: #fff; text-decoration: none; display: inline-block; text-align: center; }
#waFallback .btn-outline { margin-top: 10px; width: 100%; padding: 12px; border-radius: 10px; border: 1px solid #ddd; background: #fff; cursor: pointer; }
</style>
</head>

<body>

<!-- LOADING -->
<div id="loading">
  <h2 id="loadingTitle">‚è≥ Aguarde um momento</h2>
  <p id="loadingText">Estamos registrando seus dados üíö</p>
</div>

<!-- FALLBACK WHATSAPP (quando o sistema n√£o abre o app) -->
<div id="waFallback">
  <div class="card">
    <h3>Quase l√° ‚úÖ</h3>
    <p>
      Se o WhatsApp n√£o abriu automaticamente, use uma das op√ß√µes abaixo.
      (Isso acontece em alguns celulares dentro do Instagram/Facebook.)
    </p>

    <textarea id="waMsg" rows="7"></textarea>

    <div class="row">
      <button id="btnShareWa" type="button" class="btn btn-primary">Compartilhar</button>
      <button id="btnCopyWa" type="button" class="btn btn-primary">Copiar mensagem</button>
      <a id="btnOpenWa" class="btn btn-dark" href="#" target="_blank" rel="noopener">Abrir WhatsApp</a>
    </div>

    <button id="btnCloseWa" type="button" class="btn-outline">Fechar</button>
  </div>
</div>

<div class="folhas" id="folhas"></div>

<div class="container">

  <img
    src="https://office-net-ofc.github.io/confirmacao-de-presenca/imagens/aergergerg.PNG"
    class="header-img"
    alt="Convite Pedro D√¥mini"
  />

  <h2>üåø Confirma√ß√£o de Presen√ßa</h2>

  <div id="internalBrowserNotice" class="notice">
    ‚ö†Ô∏è Voc√™ parece estar abrindo pelo <b>navegador do Instagram/Facebook</b>.
    Se o WhatsApp n√£o abrir, toque nos <b>3 pontinhos (‚ãÆ)</b> e escolha <b>‚ÄúAbrir no navegador‚Äù</b> (Chrome/Safari).
  </div>

  <label>Qual √© o seu nome?</label>
  <input type="text" id="nome" placeholder="Digite seu nome completo" autocomplete="name">

  <label>Quantas pessoas contando com voc√™ ir√£o?</label>
  <select id="quantidade">
    <option value="">Qtd</option>
    <option>1</option><option>2</option><option>3</option>
    <option>4</option><option>5</option><option>6</option>
    <option>7</option><option>8</option><option>9</option>
    <option>10</option>
  </select>

  <label>Digite o nome das pessoas que ir√£o com voc√™:</label>
  <textarea id="pessoas" rows="4" placeholder="Ex: Maria Silva, Jo√£o Silva (5 anos)"></textarea>

  <label>Confirma presen√ßa?</label>
  <select id="status">
    <option value="Confirmado">‚úÖ Sim, estaremos presentes</option>
    <option value="N√£o poder√° comparecer">‚ùå N√£o poderemos comparecer</option>
  </select>

  <button id="btnEnviar" type="button">Enviar confirma√ß√£o üíö</button>

</div>

<script>
/** =========================
 * CONFIG (J√Å AJUSTADO)
 * ========================= */
const WHATSAPP_PHONE = "559885699508";
const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzJiVAymgiZuoWMaq1-U8ZD1n6m7cdF841LP8aYmB0LysRNbZfmbOPvKlnNftgiG30hfQ/exec";

/** =========================
 * ELEMENTOS
 * ========================= */
const nomeEl = document.getElementById("nome");
const quantidadeEl = document.getElementById("quantidade");
const pessoasEl = document.getElementById("pessoas");
const statusEl = document.getElementById("status");

const loading = document.getElementById("loading");
const loadingTitle = document.getElementById("loadingTitle");
const loadingText = document.getElementById("loadingText");

const btnEnviar = document.getElementById("btnEnviar");
const noticeEl = document.getElementById("internalBrowserNotice");

// fallback
const waFallback = document.getElementById("waFallback");
const waMsg = document.getElementById("waMsg");
const btnShareWa = document.getElementById("btnShareWa");
const btnCopyWa = document.getElementById("btnCopyWa");
const btnOpenWa = document.getElementById("btnOpenWa");
const btnCloseWa = document.getElementById("btnCloseWa");

/** =========================
 * FOLHAS (efeito visual)
 * ========================= */
const folhasContainer = document.getElementById("folhas");
const folhaImg = "https://office-net-ofc.github.io/confirmacao-de-presenca/imagens/Moldes_De_Folhas_Para_Imprimir_-_Dicas_Pr%C3%A1ticas__ABB-removebg-preview.png";

for (let i = 0; i < 20; i++) {
  const folha = document.createElement("img");
  folha.src = folhaImg;
  folha.className = "folha";
  folha.style.left = Math.random() * 100 + "vw";
  folha.style.animationDuration = (8 + Math.random() * 6) + "s";
  folha.style.animationDelay = Math.random() * 5 + "s";
  folhasContainer.appendChild(folha);
}

/** =========================
 * UTIL
 * ========================= */
function setLoading(isLoading, title, text) {
  if (title) loadingTitle.innerText = title;
  if (text) loadingText.innerText = text;
  loading.style.display = isLoading ? "flex" : "none";
  btnEnviar.disabled = isLoading;
}

function isInternalBrowser() {
  const ua = navigator.userAgent || "";
  return /Instagram|FBAN|FBAV|FB_IAB|FB4A|FBIOS|Line|Twitter|TikTok|Pinterest|Snapchat/i.test(ua);
}

function isAndroid() {
  return /Android/i.test(navigator.userAgent || "");
}

function limparTexto(s) {
  return (s || "").toString().replace(/\s+/g, " ").trim();
}

function montarMensagemWhatsApp({ nome, quantidade, pessoas, status }) {
  const pessoasTxt = pessoas ? pessoas : "N√£o informado";
  return `üåø *CONFIRMA√á√ÉO DE PRESEN√áA* üåø
üéâ Anivers√°rio de 1 ano do Pedro D√¥mini

üë§ *Nome:* ${nome}
üë• *Quantidade:* ${quantidade}
üë®‚Äçüë©‚Äçüëß *Pessoas:* ${pessoasTxt}
üìå *Status:* ${status}`;
}

function mostrarFallbackWhatsApp(mensagem, link) {
  waMsg.value = mensagem;
  btnOpenWa.href = link;

  btnCopyWa.onclick = async () => {
    try {
      await navigator.clipboard.writeText(mensagem);
      btnCopyWa.innerText = "Copiado ‚úÖ";
      setTimeout(() => btnCopyWa.innerText = "Copiar mensagem", 1500);
    } catch {
      // fallback antigo
      waMsg.focus();
      waMsg.select();
      document.execCommand("copy");
      btnCopyWa.innerText = "Copiado ‚úÖ";
      setTimeout(() => btnCopyWa.innerText = "Copiar mensagem", 1500);
    }
  };

  btnShareWa.onclick = async () => {
    if (navigator.share) {
      try {
        await navigator.share({ text: mensagem });
        return;
      } catch (e) {
        // cancelou ou falhou => fica no modal
      }
    }
    // se n√£o tem share, s√≥ mant√©m modal e sugere copiar
    btnShareWa.innerText = "N√£o dispon√≠vel";
    setTimeout(() => btnShareWa.innerText = "Compartilhar", 1500);
  };

  btnCloseWa.onclick = () => { waFallback.style.display = "none"; };

  waFallback.style.display = "block";
}

/**
 * ABERTURA BLINDADA:
 * 1) Tenta Web Share (Android) ‚Äî evita Play Store e abre seletor de apps
 * 2) Tenta intent WhatsApp normal + Business
 * 3) Tenta deep link whatsapp://
 * 4) Mostra fallback (copiar/abrir) em vez de jogar usu√°rio pra Play Store
 */
async function abrirWhatsAppComFallback(mensagem) {
  const text = encodeURIComponent(mensagem);
  const android = isAndroid();

  const universalLink = `https://wa.me/${WHATSAPP_PHONE}?text=${text}`;

  // 1) Share sheet (muito forte no Android; n√£o cai em Play Store)
  if (android && navigator.share) {
    try {
      await navigator.share({ text: mensagem });
      return;
    } catch (e) {
      // usu√°rio pode cancelar; seguimos
    }
  }

  // 2) Android intents (tentamos WhatsApp normal e Business)
  const intentWhatsApp =
    `intent://send?phone=${WHATSAPP_PHONE}&text=${text}` +
    `#Intent;scheme=whatsapp;package=com.whatsapp;end`;

  const intentBusiness =
    `intent://send?phone=${WHATSAPP_PHONE}&text=${text}` +
    `#Intent;scheme=whatsapp;package=com.whatsapp.w4b;end`;

  const deepLink = `whatsapp://send?phone=${WHATSAPP_PHONE}&text=${text}`;

  if (android) {
    window.location.href = intentWhatsApp;

    setTimeout(() => {
      window.location.href = intentBusiness;
    }, 500);

    setTimeout(() => {
      window.location.href = deepLink;
    }, 1000);

    // Em vez de redirecionar automaticamente pro wa.me (que em alguns casos vira Play Store),
    // mostramos um fallback garantido.
    setTimeout(() => {
      mostrarFallbackWhatsApp(mensagem, universalLink);
    }, 1700);
  } else {
    // iOS: wa.me costuma ser ok, mas mantemos fallback
    window.location.href = universalLink;

    setTimeout(() => {
      mostrarFallbackWhatsApp(mensagem, universalLink);
    }, 1200);
  }
}

async function salvarNoSheets({ nome, quantidade, pessoas, status }) {
  const formData = new FormData();
  formData.append("nome", nome);
  formData.append("quantidade", quantidade);
  formData.append("pessoas", pessoas);
  formData.append("status", status);
  formData.append("origem", "github-pages");

  const resp = await fetch(GOOGLE_SCRIPT_URL, {
    method: "POST",
    body: formData
  });

  const data = await resp.json().catch(() => null);

  if (!data || !data.ok) {
    const msg = (data && data.error) ? data.error : "Falha ao salvar na planilha.";
    throw new Error(msg);
  }
  return true;
}

/** =========================
 * A√á√ÉO PRINCIPAL
 * ========================= */
async function enviar() {
  const nome = limparTexto(nomeEl.value);
  const quantidade = limparTexto(quantidadeEl.value);
  const pessoas = limparTexto(pessoasEl.value);
  const status = limparTexto(statusEl.value);

  if (!nome || nome.length < 3) {
    alert("Digite seu nome completo üòä");
    nomeEl.focus();
    return;
  }
  if (!quantidade) {
    alert("Selecione a quantidade de pessoas üòä");
    quantidadeEl.focus();
    return;
  }

  setLoading(true, "‚è≥ Aguarde um momento", "Estamos registrando seus dados üíö");

  try {
    // 1) salva primeiro (garante registro)
    await salvarNoSheets({ nome, quantidade, pessoas, status });

    // 2) abre WhatsApp
    setLoading(true, "‚úÖ Tudo certo!", "Abrindo o WhatsApp com a mensagem pronta üíö");
    const mensagem = montarMensagemWhatsApp({ nome, quantidade, pessoas, status });
    await abrirWhatsAppComFallback(mensagem);

    // some com overlay (se share foi usado, pode n√£o voltar; tudo bem)
    setTimeout(() => setLoading(false), 2500);
  } catch (err) {
    console.error(err);
    setLoading(true, "‚ùå Erro", "N√£o conseguimos salvar seus dados. Tente novamente.");
    setTimeout(() => {
      setLoading(false);
      alert("Erro ao salvar na planilha: " + (err.message || "tente novamente."));
    }, 1200);
  }
}

/** =========================
 * INIT
 * ========================= */
btnEnviar.addEventListener("click", enviar);

if (isInternalBrowser()) {
  noticeEl.style.display = "block";
}
</script>

</body>
</html>
