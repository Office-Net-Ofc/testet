/**********************
 * PLANILHA / ABA
 **********************/
const SPREADSHEET_ID = "1w6gDFhG1Ctqc0jcRSXNVKGyQLM1Gon8rBhfzb5mvxYE";
const SHEET_NAME = "Respostas";

/**********************
 * WHATSAPP CLOUD API
 **********************/
const WA_TOKEN = "COLE_AQUI_O_TOKEN_PERMANENTE"; // <-- cole no Apps Script (NUNCA no HTML)
const PHONE_NUMBER_ID = "874577072414510";

// Template aprovado
const TEMPLATE_NAME = "confirmacao_presenca_evento";
const TEMPLATE_LANG = "pt_BR";

// Números da organização (recebem a confirmação)
const ORG_WHATSAPPS = [
  "5598981876585",
  "5598985699508"
];

/**********************
 * WEB APP
 **********************/
function doPost(e) {
  try {
    const ss = SpreadsheetApp.openById(SPREADSHEET_ID);
    const sheet = ss.getSheetByName(SHEET_NAME);
    if (!sheet) return jsonResponse({ ok: false, error: `Aba "${SHEET_NAME}" não encontrada.` });

    const p = (e && e.parameter) ? e.parameter : {};

    const nome = String(p.nome || "").trim();
    const quantidade = String(p.quantidade || "").trim();
    const pessoas = String(p.pessoas || "").trim();
    const status = String(p.status || "Confirmado").trim();
    const origem = String(p.origem || "site").trim();

    if (!nome || !quantidade) {
      return jsonResponse({ ok: false, error: "Nome e quantidade são obrigatórios." });
    }

    // 1) Grava na planilha (mesmo formato do seu código antigo + origem)
    sheet.appendRow([new Date(), nome, quantidade, pessoas, status, origem]);

    // 2) Envia template para os 2 números
    const waResults = [];
    for (const numero of ORG_WHATSAPPS) {
      const resp = enviarTemplateWhatsApp({
        to: numero,
        nome,
        quantidade,
        pessoas,
        status
      });
      waResults.push({ numero, ok: true, resp });
    }

    return jsonResponse({ ok: true, wa: waResults });

  } catch (err) {
    return jsonResponse({ ok: false, error: String(err && err.message ? err.message : err) });
  }
}

function doGet() {
  return jsonResponse({ ok: true, message: "WebApp online ✅" });
}

function enviarTemplateWhatsApp({ to, nome, quantidade, pessoas, status }) {
  const url = `https://graph.facebook.com/v22.0/${PHONE_NUMBER_ID}/messages`;

  const payload = {
    messaging_product: "whatsapp",
    to,
    type: "template",
    template: {
      name: TEMPLATE_NAME,
      language: { code: TEMPLATE_LANG },
      components: [
        {
          type: "body",
          parameters: [
            { type: "text", text: nome || "-" },
            { type: "text", text: quantidade || "-" },
            { type: "text", text: pessoas || "-" },
            { type: "text", text: status || "-" }
          ]
        }
      ]
    }
  };

  const res = UrlFetchApp.fetch(url, {
    method: "post",
    contentType: "application/json",
    headers: { Authorization: `Bearer ${WA_TOKEN}` },
    payload: JSON.stringify(payload),
    muteHttpExceptions: true
  });

  const code = res.getResponseCode();
  const body = res.getContentText();

  if (code < 200 || code >= 300) {
    throw new Error(`Erro WhatsApp API (${code}): ${body}`);
  }

  return JSON.parse(body);
}

function jsonResponse(obj) {
  return ContentService
    .createTextOutput(JSON.stringify(obj))
    .setMimeType(ContentService.MimeType.JSON);
}
